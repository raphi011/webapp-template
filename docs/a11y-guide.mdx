import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Docs/Accessibility Guide" />

# Accessibility (A11y) Guide

Learnings and best practices from enabling automated a11y testing with `@storybook/addon-a11y` and axe-core.

## Setup

A11y testing runs in CI via `bun run test:ci`. The addon is configured in `.storybook/preview.tsx`:

```typescript
parameters: {
  a11y: {
    test: "error",  // Fails CI on violations
    config: {
      rules: [{ id: "color-contrast", enabled: false }],  // Global override
    },
  },
},
```

The `test` option accepts `"off"` | `"todo"` | `"error"` — there is no warn-only mode.

## Common Violations & Fixes

### `button-name` — Icon-only buttons need `aria-label`

Buttons that contain only an icon (no visible text) must have an `aria-label`:

```tsx
// Bad
<Button variant="outline" size="sm" onClick={onCopy}>
  <ClipboardDocumentIcon className="size-4" />
</Button>

// Good
<Button variant="outline" size="sm" onClick={onCopy} aria-label={t("copy")}>
  <ClipboardDocumentIcon className="size-4" />
</Button>
```

Affected components: `club-join-card.tsx`, `club-switcher.tsx`, `DropdownMenu` trigger.

**In stories**: Form controls without a label in the story context need `aria-label` in story args:

```typescript
const meta = preview.meta({
  args: { "aria-label": "Eingabe" },
});
```

Or provide a `label` prop if the component supports it (e.g. `Switch`, `Checkbox`).

### `nested-interactive` — No buttons inside Tooltips

Tooltip wraps content in a focusable element. Nesting a `<button>` inside creates two tab stops for one visual element:

```tsx
// Bad — button inside Tooltip
<Tooltip content={date}>
  <button className="...">{label}</button>
</Tooltip>

// Good — non-interactive span with role="text"
<Tooltip content={date}>
  <span role="text" className="cursor-default ...">{label}</span>
</Tooltip>
```

### `scrollable-region-focusable` — Scrollable areas need `tabIndex`

Scrollable containers must be keyboard-navigable:

```tsx
// Add tabIndex={0} to the scrollable div
<div ref={viewportRef} tabIndex={0} className="overflow-auto ...">
```

### `heading-order` — Skipped heading levels

Page stories that embed components with `<h3>` inside a `<CardTitle>` skip `<h2>`. This is an application-level concern, not a component bug. Override per-story:

```typescript
parameters: {
  a11y: { config: { rules: [{ id: "heading-order", enabled: false }] } },
},
```

### `color-contrast` — Insufficient contrast ratios

WCAG AA requires 4.5:1 for normal text, 3:1 for large text. Our `slate-400` on white backgrounds fails in some cases. This is disabled globally while the design system is being finalized.

## Critical Gotcha: Parameter Merging

**Storybook parameter arrays REPLACE, they do not merge.** If the global config disables `color-contrast` and a story disables `heading-order`, the story override **replaces** the global array — re-enabling `color-contrast`:

```typescript
// Global: [{ id: "color-contrast", enabled: false }]

// Story — THIS LOSES the global color-contrast disable!
parameters: {
  a11y: { config: { rules: [{ id: "heading-order", enabled: false }] } },
},

// Correct — include BOTH rules
parameters: {
  a11y: { config: { rules: [
    { id: "heading-order", enabled: false },
    { id: "color-contrast", enabled: false },
  ] } },
},
```

This affects all 6 fullscreen page stories that need the `heading-order` override.

## Checklist for New Components

1. **Icon-only buttons**: Always add `aria-label`
2. **Form controls in stories**: Provide `label` or `aria-label` in story args
3. **Tooltips**: Never wrap interactive elements — use `<span>` or `<div>` as trigger
4. **Scrollable containers**: Add `tabIndex={0}`
5. **Touch targets**: Minimum 44x44px (`min-h-11 min-w-11`)
6. **Images**: Add `alt` text (or `aria-hidden="true"` for decorative images)
7. **Avatar sr-only text**: Avatar renders a hidden `<span className="sr-only">{name}</span>` — this causes `getByText` to find multiple matches in tests. Use `getAllByText` instead.

## Checklist for New Stories

1. Run `bun run test:ci` after adding stories
2. If a story has an unfixable violation, add a per-story `a11y` parameter override — but include ALL global rule disables too (see "Parameter Merging" above)
3. Form controls need labels — either via `label` prop or `aria-label` in args
4. Page stories with `CardTitle` (`<h3>`) usually need `heading-order` disabled
